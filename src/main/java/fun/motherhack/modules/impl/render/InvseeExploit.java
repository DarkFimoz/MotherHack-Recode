package fun.motherhack.modules.impl.render;

import com.google.gson.*;
import fun.motherhack.api.events.impl.EventAttackEntity;
import fun.motherhack.api.events.impl.EventPacket;
import fun.motherhack.api.events.impl.EventPlayerTick;
import fun.motherhack.api.events.impl.EventRender2D;
import fun.motherhack.modules.api.Category;
import fun.motherhack.modules.api.Module;
import fun.motherhack.modules.settings.api.Nameable;
import fun.motherhack.modules.settings.impl.BooleanSetting;
import fun.motherhack.modules.settings.impl.EnumSetting;
import fun.motherhack.utils.math.TimerUtils;
import fun.motherhack.utils.network.ChatUtils;
import fun.motherhack.utils.render.ColorUtils;
import fun.motherhack.utils.render.Render2D;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.client.gui.screen.ingame.GenericContainerScreen;
import net.minecraft.item.Item;
import net.minecraft.item.ItemStack;
import net.minecraft.network.packet.s2c.play.InventoryS2CPacket;
import net.minecraft.registry.Registries;
import net.minecraft.util.Identifier;

import java.awt.*;
import java.io.*;
import java.util.ArrayList;
import java.util.List;

public class InvseeExploit extends Module {

    private final EnumSetting<Mode> mode = new EnumSetting<>("Mode", Mode.Sender);
    private final BooleanSetting debug = new BooleanSetting("Debug", false);

    private final File configDir = new File(mc.runDirectory, "files/modules");
    private final File targetFile = new File(configDir, "InvseeExploitName.ew");
    private final File invFile = new File(configDir, "InvseeExploitItems.ew");

    private final Gson gson = new GsonBuilder().setPrettyPrinting().create();

    private final List<ItemStack> invseeItems = new ArrayList<>();
    private final TimerUtils timerUtil = new TimerUtils();

    public InvseeExploit() {
        super("InvseeExploit", Category.Render);
        configDir.mkdirs();
    }

    @EventHandler
    public void onAttack(EventAttackEntity event) {
        if (!isToggled() || mode.getValue() != Mode.Sender) return;
        try (FileWriter writer = new FileWriter(targetFile)) {
            JsonObject obj = new JsonObject();
            obj.addProperty("target", event.getTarget().getName().getString());
            gson.toJson(obj, writer);
            if (debug.getValue()) {
                ChatUtils.sendMessage("Получен таргет - " + event.getTarget().getName().getString());
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @EventHandler
    public void onRender2D(EventRender2D event) {
        if (!isToggled() || mode.getValue() != Mode.Sender) return;
        if (debug.getValue() && timerUtil.passed(1000)) { // Сообщение раз в секунду
            ChatUtils.sendMessage("Рендер инвентаря: предметов " + invseeItems.size());
            timerUtil.reset();
        }
        float x = 800;
        float y = 200;
        float slotSize = 16.0F;
        int columns = 9;
        int rows = 4;

        float totalWidth = slotSize * columns;
        float totalHeight = slotSize * rows;

        float headerHeight = 18.0F;
        float spacing = 3.0F;

        Render2D.drawRoundedRect(event.getContext().getMatrices(), x, y, totalWidth + 4, headerHeight, 4, ColorUtils.getGlobalColor());

        Render2D.drawRoundedRect(event.getContext().getMatrices(), x, y + headerHeight - 2, totalWidth + 4, totalHeight + 6, 0, new Color(22, 22, 22, 130));

        event.getContext().drawText(mc.textRenderer, "Инвентарь противника", (int) (x + (totalWidth + 4) / 2F - mc.textRenderer.getWidth("Инвентарь противника") / 2F), (int) (y + headerHeight / 2F - 5), -1, false);

        while (invseeItems.size() < 46) {
            invseeItems.add(ItemStack.EMPTY);
        }

        int slotIndex = 9;
        for (int row = 0; row < rows; row++) {
            for (int col = 0; col < columns; col++) {
                float slotX = x + 2 + col * slotSize;
                float slotY = y + headerHeight + spacing + row * slotSize;

                ItemStack stack;
                if (row < 3) {
                    stack = invseeItems.get(slotIndex);
                    slotIndex++;
                } else {
                    stack = invseeItems.get(col);
                }

                if (!stack.isEmpty()) {
                    event.getContext().getMatrices().push();
                    event.getContext().getMatrices().translate(slotX, slotY, 0);
                    event.getContext().getMatrices().scale(0.92f, 0.92f, 1);
                    event.getContext().drawItem(stack, 0, 0);
                    event.getContext().drawStackOverlay(mc.textRenderer, stack, 0, 0);
                    event.getContext().getMatrices().pop();
                }
            }
        }
    }

    @EventHandler
    public void onPlayerTick(EventPlayerTick event) {
        if (!isToggled()) return;
        if (mode.getValue() == Mode.Receiver) {
            if (timerUtil.passed(2000)) {
                if (!targetFile.exists()) {
                    if (debug.getValue()) {
                        ChatUtils.sendMessage("Файл InvseeExploitName.ew не существует");
                    }
                    return;
                }
                try (FileReader reader = new FileReader(targetFile)) {
                    JsonObject obj = gson.fromJson(reader, JsonObject.class);
                    String targetName = obj.get("target").getAsString();
                    mc.getNetworkHandler().sendCommand("invsee " + targetName);
                    timerUtil.reset();
                    if (debug.getValue()) {
                        ChatUtils.sendMessage("Отправлена команда invsee для " + targetName);
                    }
                } catch (Exception e) {
                    if (debug.getValue()) {
                        ChatUtils.sendMessage("Ошибка при чтении targetFile: " + e.getMessage());
                    }
                    e.printStackTrace();
                }
            }
        } else if (mode.getValue() == Mode.Sender) {
            if (!invFile.exists()) {
                if (debug.getValue()) {
                    ChatUtils.sendMessage("Файл InvseeExploitItems.ew не существует");
                }
                return;
            }
            try (FileReader reader = new FileReader(invFile)) {
                JsonArray array = gson.fromJson(reader, JsonArray.class);
                invseeItems.clear();
                for (JsonElement element : array) {
                    JsonObject obj = element.getAsJsonObject();
                    Identifier id = Identifier.tryParse(obj.get("id").getAsString());
                    if (id != null && Registries.ITEM.containsId(id)) {
                        Item item = Registries.ITEM.get(id);
                        ItemStack stack = new ItemStack(item, obj.get("count").getAsInt());
                        invseeItems.add(stack);
                    }
                }
                if (debug.getValue()) {
                    ChatUtils.sendMessage("Загружено предметов: " + invseeItems.size());
                }
            } catch (Exception e) {
                if (debug.getValue()) {
                    ChatUtils.sendMessage("Ошибка при чтении invFile: " + e.getMessage());
                }
            }
        }
    }

    @EventHandler
    public void onPacket(EventPacket event) {
        if (!isToggled() || !(event.getPacket() instanceof InventoryS2CPacket packet) || mode.getValue() != Mode.Receiver) return;
        try {
            String targetName;
            try (FileReader reader = new FileReader(targetFile)) {
                JsonObject obj = gson.fromJson(reader, JsonObject.class);
                targetName = obj.get("target").getAsString();
            }
            if (mc.player == null || mc.player.getName().getString().equalsIgnoreCase(targetName) || mc.player.currentScreenHandler == null || !(mc.currentScreen instanceof GenericContainerScreen)) {
                return;
            }

            invseeItems.clear();

            int limit = Math.min(36, packet.getContents().size());
            for (int i = 0; i < limit; i++) {
                ItemStack stack = packet.getContents().get(i);
                invseeItems.add(stack.isEmpty() ? ItemStack.EMPTY : stack.copy());
            }

            while (invseeItems.size() < 36) {
                invseeItems.add(ItemStack.EMPTY);
            }

            try (FileWriter writer = new FileWriter(invFile)) {
                JsonArray array = new JsonArray();
                for (ItemStack stack : invseeItems) {
                    JsonObject stackObj = new JsonObject();
                    Identifier id = Registries.ITEM.getId(stack.getItem());
                    stackObj.addProperty("id", id.toString());
                    stackObj.addProperty("count", stack.getCount());
                    array.add(stackObj);
                }
                gson.toJson(array, writer);
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void onDisable() {
        super.onDisable();
        invseeItems.clear();
    }

    public enum Mode implements Nameable {
        Sender("Отправляющий"),
        Receiver("Получающий");

        private final String name;

        Mode(String name) {
            this.name = name;
        }

        @Override
        public String getName() {
            return name;
        }
    }
}